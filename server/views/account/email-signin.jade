extends ../layout

block content
    style.
        body {
            background-color:#000;
            color:#fff;
            font-family:'Segoe UI', Arial, sans-serif;
            width:100%; height:100%; margin:0; padding:0;
        }
        .container {
            background-color:#000;
        }
        .video-section,
        .video-container {
            background-color:#000;
        }
        .video-container {
            border-radius:8px;
            overflow:hidden;
            width:100%;
            height:360px;
            max-width:540px;
            box-shadow:0 4px 8px rgba(0,0,0,0.6);
            position:relative;
            margin:0 auto 15px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        video#redrockMainVideo {
            width:auto;
            height:100%;
            max-height:100%;
            max-width:100%;
            object-fit:contain;
            display:block;
        }
        /* Darken blacks on the initial autoplay sequence */
        video#redrockMainVideo.enhance-black {
            filter:brightness(.75) contrast(1.35) saturate(.9);
        }
        .form-control {
            text-align:center;
            background-color:#000;
            border-color:#444;
            color:#fff;
            border-radius:4px;
            height:36px;
        }
        .form-control:hover {cursor:pointer; color:#fff; border-color:#2563eb;}
        .inline-link {color:#2563eb; display:block; text-align:center; margin-top:10px; font-size:12px; margin-left:auto; margin-right: auto;}
        .inline-link.active {background-color:#1a365d; border-color:#2563eb; color:#fff;}
        .external-link {color:#2563eb; display:block; text-align:center; margin-top:10px; font-size:12px; margin-left:auto; margin-right: auto;}
        #magic-btn {background-color:#2563eb; border:none; border-radius:4px; padding:0 8px; width:270px;}

        .alt-signup {text-align: center; margin-top: 20px; font-size: 12px;}
        .alt-signup a {color: #2563eb;}
        .form-col {
            display:flex;
            align-items:center;
            justify-content:center;
            flex-direction:column;
            min-height:360px;
        }
        .form-panel {
            width:100%;
            max-width:320px;
            display:flex;
            flex-direction:column;
            align-items:center;
        }
        form.auth-form {
            width:100%;
            display:flex;
            flex-direction:column;
            align-items:center;
        }
        form.auth-form .form-group {
            width:100%;
            text-align:left;
        }
        form.auth-form button#magic-btn { margin-top:6px; }
        .inline-link, .external-link { width:270px; }

    .container(style='padding-top:28px; min-height:calc(100vh - 160px); color:#fff; width:100%; height:100%;')

        .row
            .col-md-6.col-sm-12.form-col
                .video-section
                    .video-container
                        // NOTE: no controls attribute; muted for autoplay
                        video#redrockMainVideo.enhance-black(autoplay loop muted playsinline preload='auto' data-state='auto')
                            source(src='/assets/videos/midjourney_redrockcode_spinning_mountain_range.mp4', type='video/mp4')
                            | Your browser does not support the video tag.
            .col-md-6.col.sm-12.form-col
                .form-panel
                    form.auth-form(method='POST', action='/signin')
                        input(type='hidden', name='_csrf', value=_csrf)
                        .form-group(style='padding-top:16px;')
                            label(for='email') Email
                            input.form-control(type='email', name='email', id='email', autocomplete='email', value='#{email ? email : ""}', placeholder='you@example.com', autofocus=true, required)
                        .form-group
                            label(for='password') Password
                            input.form-control(type='password', name='password', id='password', autocomplete='current-password', placeholder='••••••••', required)
                        button#magic-btn.btn.btn-primary.btn-block(type='submit') Sign In
                        div.alt-signup(style='width: 270px;')
                            if !settings.isSignUpDisabled
                                span New here?
                                a(href='/create-account')   Sign up!

                    a.form-control.inline-link(data-video='/assets/videos/redrockcode_intro_1.mp4' href='javascript:void(0)')  2 minutes: Introduction to Redrock Code
                    a.form-control.inline-link(data-video='/assets/videos/redrockcode_intro_2.mp4' href='javascript:void(0)') 14 minutes: What will I learn?
                    a.form-control.external-link(target='_blank' href='https://silvermedal.online' style='margin: auto; margin-top: 10px;') * Check out our game demo *
    script.
        const player = document.getElementById('redrockMainVideo');
        const sourceEl = player.querySelector('source');
        const QUEUE_AT_SECONDS = 4;
        let queuedBlobUrl = null;

        queueVideo = (queuedSrc, userSelected, delay = QUEUE_AT_SECONDS) => {

            fetch(queuedSrc, { cache: 'force-cache' })
            .then(r => r.ok ? r.blob() : Promise.reject(r.status))
            .then(blob => { 

                setTimeout(() => {
                    queuedBlobUrl = URL.createObjectURL(blob); 
                    if (userSelected) {
                        player.muted = false; // allow audio now
                        player.controls = true; // show controls ONLY on manual selection
                    }

                    player.pause();
                    player.currentTime = 0;
                    sourceEl.src = queuedBlobUrl;
                    player.classList.remove('enhance-black'); // remove filter for queued video
                    player.load();
                    player.play();
        
                }, delay * 1000);
            }).catch(() => { queuedBlobUrl = null; });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const links = document.querySelectorAll('.inline-link');
            const QUEUE_AT_SECONDS = 4;
            const queuedSrc = '/assets/videos/redrockcode_intro_0_1080.mp4';
            let userSelected = false;

            queueVideo(queuedSrc, false);

            links.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    links.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    queueVideo(link.getAttribute('data-video'), true, 0);
                });
            });
        });
